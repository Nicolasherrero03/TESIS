<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación</title>

    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.163.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/"
      }
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- El link a Google Fonts ha sido eliminado -->

    <style>
        /* --- Declaración de la fuente local --- */
        @font-face {
            font-family: 'Thermal VF';
            /* Asegúrate de que la ruta al archivo de la fuente sea correcta */
            src: url('Thermal-VF.woff2') format('woff2-variations'); 
            font-weight: 100 900;
            font-style: normal italic;
        }

        /* --- Paleta de Colores y Fuentes --- */
        :root {
            --main-pink: #FF1493;  /* Fucsia/Rosa Fuerte */
            --main-purple: #4a003f; /* Morado Oscuro (para títulos) */
            --viz-bg: #f0fff0;     /* Verde Pálido (Honeydew) */
            --right-bg: #fdf5e6;   /* Beige Pálido (OldLace) */
            --main-bg: #fdfdfa;    /* Fondo general (Off-white) */
            
            --font-main: 'Thermal VF', monospace; /* <-- FUENTE CAMBIADA */
            --main-border: 2px solid #000;
            --dotted-border: 2px dotted #444; /* Borde punteado */

            /* Colores cálidos para el fondo animado */
            --warm-orange: #ffab40; /* Naranja cálido */
            --warm-red: #ff3d00;   /* Rojo cálido */
            --warm-yellow: #ffd740; /* Amarillo cálido */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--main-bg);
            color: #000;
            margin: 0;
            padding: 20px;
            display: flex;
            height: calc(100vh - 40px);
            gap: 20px;
            overflow: hidden; 
            position: relative; 
            z-index: 1; 
        }

        /* === FONDO ANIMADO CÁLIDO === */
        #animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
            pointer-events: none; 
            overflow: hidden; 
            opacity: 0.2; 
        }
        #animated-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, var(--warm-orange), var(--warm-red), var(--warm-yellow), var(--warm-orange));
            background-size: 200% 200%;
            animation: gradientMove 30s ease infinite alternate; 
        }
        #animated-background::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='0.05'%3E%3Cpath d='M0 0h10v10H0V0zm10 0h10v10H10V0zM0 10h10v10H0V10zm10 10h10v-10H10V10z'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 20px 20px;
            animation: patternMove 60s linear infinite; 
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
        }
        @keyframes patternMove {
            0% { background-position: 0 0; } 100% { background-position: 200px 200px; } 
        }

        /* --- Keyframes para las nuevas animaciones --- */
        @keyframes h1GradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes h1TextColor {
            0% { color: #ffffff; }
            50% { color: #ffc0cb; } /* Rosa pálido */
            100% { color: #ffffff; }
        }
        @keyframes subtleFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-5px); }
        }

        /* --- CONTENIDO PRINCIPAL (z-index) --- */
        .controls-column,
        .visualization-column,
        .right-column,
        .back-link,
        .juego-link {
            z-index: 2; 
            position: relative; 
        }

        /* --- TÍTULOS Y CONTROLES --- */
        .boxed-label {
            border: var(--main-border);
            padding: 4px 8px;
            display: inline-block; 
            margin-bottom: 10px; 
            width: fit-content; 
            font-weight: bold; 
            font-size: 0.9rem;
            background-color: #fff;
            transition: all 0.2s ease-out;
        }
        .boxed-label:hover {
            background-color: #000;
            color: var(--main-pink); 
        }
        
        h1 {
            font-family: var(--font-main);
            font-style: italic;
            font-weight: 500;
            font-size: 2rem; 
            background: linear-gradient(-45deg, var(--main-purple), var(--main-pink), #8A2BE2, var(--main-purple));
            background-size: 200% 200%;
            animation: 
                h1GradientMove 10s ease infinite,
                h1TextColor 8s ease-in-out infinite alternate;
            color: #fff; 
            border: var(--main-border);
            padding: 10px 15px;
            text-align: center;
            flex-shrink: 0;
            margin: 0;
            margin-bottom: 15px;
        }
        
        /* --- ESTILOS DE SLIDERS PERSONALIZADOS --- */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none; 
            background: transparent;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            background-color: var(--main-pink); 
            border-radius: 50%;
            border: var(--main-border);
            margin-top: -9px; 
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            background-color: var(--main-pink); 
            border-radius: 50%;
            border: var(--main-border);
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 3px;
            background-color: #ddd; 
            border: 1px solid #ccc;
        }
        input[type=range]::-moz-range-track {
            height: 3px;
            background-color: #ddd;
            border: 1px solid #ccc;
        }

        /* --- ESTRUCTURA DE 3 COLUMNAS --- */

        /* --- 1. COLUMNA IZQUIERDA (Controles) --- */
        .controls-column {
            flex-basis: 25%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            animation: subtleFloat 6s ease-in-out infinite alternate;
        }

        #parameters-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            flex-grow: 1; /* Se encoge */
            padding: 20px; 
            border: var(--dotted-border);
            background-color: #fff;
        }

        #loading-indicator {
            text-align: center; color: var(--main-pink); margin-top: 20px; font-style: italic;
        }

        #consecuencias-box {
            flex-basis: 300px; /* Altura aumentada */
            flex-shrink: 0; 
            border: var(--dotted-border);
            display: flex;
            overflow: hidden;
            background-color: #fff;
        }
        #consecuencias-box h3 {
            font-family: var(--font-main);
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            background-color: var(--main-purple);
            color: var(--main-pink);
            padding: 10px 8px;
            margin: 0;
            text-align: center;
            font-size: 1rem;
            letter-spacing: 2px;
        }

        .consecuencias-content {
            flex-grow: 1;
            padding: 10px;
            font-size: 1 rem;
            position: relative; 
            height: 100%;
        }

        /* --- 2. COLUMNA CENTRAL (Visualización) --- */
        .visualization-column {
            flex-grow: 1;
            position: relative;
            border: var(--dotted-border);
            background-color: var(--viz-bg); 
            display: flex;
            justify-content: center;
            align-items: center;
            animation: subtleFloat 6s ease-in-out infinite alternate;
            animation-delay: -2s;
        }
        #shape-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* --- 3. COLUMNA DERECHA (Info) --- */
        .right-column {
            flex-basis: 15%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: subtleFloat 6s ease-in-out infinite alternate;
            animation-delay: -4s;
        }
        .right-box {
            border: var(--dotted-border);
            width: 100%;
            box-sizing: border-box;
            padding: 15px; /* Un poco más de padding */
            background-color: var(--right-bg); 
            overflow-y: auto; /* Scroll si el texto es muy largo */
        }
        .right-box h3 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--main-purple);
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .right-box p {
            font-size: 1rem;
            line-height: 1.5;
            margin: 0;
        }
        .top-box { flex-basis: 30%; flex-shrink: 0; }
        .bottom-box { flex-grow: 1; }

        /* --- Links Flotantes --- */
        .back-link, .juego-link {
            position: fixed;
            font-size: 1rem;
            text-decoration: none;
            color: #000;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border: 1px solid #000;
            font-family: var(--font-main);
            transition: all 0.2s ease-out;
        }
        .back-link:hover, .juego-link:hover { 
            background-color: var(--main-pink); 
            color: #fff;
            border-color: var(--main-purple);
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .back-link { bottom: 20px; right: 20px; }
        .juego-link { bottom: 895px; right: 322px; } 

    </style>
</head>
<body>

    <div id="animated-background"></div> 

    <aside class="controls-column">
        <h1>SIMULACIÓN</h1>
        <div id="parameters-wrapper">
            <div class="parameter">
                <label for="param1" class="boxed-label">Densidad Edilicia</label>
                <input type="range" id="param1" name="param1" min="1" max="5" step="1" value="3" list="param-ticks">
            </div>
            <div class="parameter">
                <label for="param2" class="boxed-label">Negocios</label>
                <input type="range" id="param2" name="param2" min="1" max="5" step="1" value="3" list="param-ticks">
            </div>
            <div class="parameter">
                <label for="param3" class="boxed-label">Perfil Gastronomico</label>
                <input type="range" id="param3" name="param3" min="1" max="5" step="1" value="3" list="param-ticks">
            </div>
            <div class="parameter">
                <label for="param4" class="boxed-label">Oficios</label>
                <input type="range" id="param4" name="param4" min="1" max="5" step="1" value="3" list="param-ticks">
            </div>
            <datalist id="param-ticks">
                <option value="1"></option><option value="2"></option><option value="3"></option><option value="4"></option><option value="5"></option>
            </datalist>
            <div id="loading-indicator">Cargando modelo...</div>
        </div>
        <div id="consecuencias-box">
            <h3>CONSECUENCIAS</h3>
            <div class="consecuencias-content">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </aside>

    <main class="visualization-column">
        <canvas id="shape-canvas"></canvas>
    </main>

    <aside class="right-column">
        <div class="right-box top-box" id="info-box"></div>
        <div class="right-box bottom-box"></div>
    </aside>

    <a href="index.html" class="back-link">Volver a la Home</a>
    <a href="juego.html" class="juego-link">Recorrer</a>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // === LÓGICA DE MODELOS ===
        let loadedModels = new Array(5); // Un array para guardar los 5 modelos
        let currentModel = null; // El modelo que se está viendo ahora
        let scene; 
        let consequencesChart = null; 
        let controls; 
        
        // ==============================================================
        // === ¡EDITÁ ESTA LISTA CON LOS NOMBRES DE TUS 5 MODELOS! ===
        // ==============================================================
        const modelFiles = [
            'chaca100.glb',     // Paso 1
            'chaca100.glb',     // Paso 2 (Repetimos)
            'PruebaGoat.glb',     // Paso 3 (Repetimos)
            'chacaiaiai.glb',      // Paso 4 (Empezamos a cambiar)
            'CHACAno.glb'       // Paso 5
        ];
        // ==============================================================

        // --- Textos para la caja de información ---
        // --- ¡EDITA ESTOS TEXTOS! ---
        const parameterInfo = {
            param1: {
                title: "Densidad Edilicia",
                descriptions: [
                    "Nivel 1: Baja densidad. Predominan las casas bajas y los espacios verdes, generando un ambiente tranquilo y poco poblado.",
                    "Nivel 2: Densidad media-baja. Combinación de casas y edificios de pocos pisos. El barrio comienza a compactarse.",
                    "Nivel 3: Densidad media. Equilibrio entre edificios residenciales y comerciales. El flujo de personas y vehículos es constante.",
                    "Nivel 4: Densidad media-alta. Abundancia de edificios altos, con una mezcla de oficinas y viviendas. La actividad es alta.",
                    "Nivel 5: Alta densidad. Un centro urbano con rascacielos, alta concentración de personas y una infraestructura compleja."
                ]
            },
            param2: {
                title: "Negocios",
                descriptions: [
                    "Nivel 1: Zona residencial. Pocos o ningún negocio, el área es principalmente para viviendas.",
                    "Nivel 2: Pequeños comercios. Aparecen tiendas de barrio, kioscos y servicios básicos para los residentes.",
                    "Nivel 3: Variedad comercial. Se suman supermercados, tiendas de ropa y una mayor oferta de servicios.",
                    "Nivel 4: Centro comercial. Gran concentración de tiendas, bancos y oficinas. Atrae a gente de otras zonas.",
                    "Nivel 5: Distrito financiero. Sede de grandes corporaciones, con un enfoque en negocios y finanzas a gran escala."
                ]
            },
            param3: {
                title: "Perfil Gastronómico",
                descriptions: [
                    "Nivel 1: Oferta básica. Principalmente rotiserías y pequeños cafés locales.",
                    "Nivel 2: Comida rápida y bares. Se instalan cadenas de comida rápida y bares de barrio.",
                    "Nivel 3: Restaurantes variados. Aparecen restaurantes de gama media con diversas cocinas internacionales.",
                    "Nivel 4: Polo gastronómico. El área se convierte en un destino para comer, con restaurantes de autor y alta cocina.",
                    "Nivel 5: Exclusividad y lujo. Restaurantes con estrellas Michelin y una oferta culinaria de élite."
                ]
            },
            param4: {
                title: "Oficios",
                descriptions: [
                    "Nivel 1: Oficios tradicionales. Talleres mecánicos, carpinterías y oficios de mantenimiento del hogar.",
                    "Nivel 2: Servicios profesionales. Se suman estudios de abogados, contadores y consultorios médicos.",
                    "Nivel 3: Creatividad y diseño. Aparecen estudios de diseño gráfico, arquitectura y agencias de publicidad.",
                    "Nivel 4: Tecnología e innovación. Empresas de software, startups y espacios de coworking dominan el área.",
                    "Nivel 5: Alta tecnología y finanzas. Centros de investigación, desarrollo tecnológico y sedes financieras."
                ]
            }
        };


        function mapRange(value, inMin, inMax, outMin, outMax) {
            if (inMin === inMax) return outMin;
            return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
        }

        try {
            const container = document.querySelector('.visualization-column');
            const canvas = document.getElementById('shape-canvas');
            scene = new THREE.Scene(); 
            scene.background = new THREE.Color(0xf0fff0); 

            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(20, 15, 20); 
            camera.lookAt(0, 0, 0); 

            const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
            renderer.outputEncoding = THREE.sRGBEncoding;

            controls = new OrbitControls(camera, renderer.domElement); 
            controls.enableDamping = true;
            controls.target.set(0, 0, 0); 

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-5, -5, -5);
            scene.add(directionalLight2);

            const infoBox = document.getElementById('info-box');

            const controlsObj = { 
                param1: document.getElementById('param1'),
                param2: document.getElementById('param2'),
                param3: document.getElementById('param3'),
                param4: document.getElementById('param4'),
            };
            const loadingIndicator = document.getElementById('loading-indicator');

            // --- FUNCIÓN DE ACTUALIZACIÓN (CON LÓGICA MEJORADA) ---
            function updateModelParameters() {
                // No hacer nada si los modelos no están cargados
                if (loadedModels.some(m => m === undefined)) return; 

                // --- Leer valores de sliders ---
                const val1 = parseInt(controlsObj.param1.value); // 1-5
                const val2 = parseInt(controlsObj.param2.value);
                const val3 = parseInt(controlsObj.param3.value);
                const val4 = parseInt(controlsObj.param4.value);
                
                // --- 1. LÓGICA DE CAMBIO DE MODELO (MEJORADA) ---
                const newModelIndex = val1 - 1; // 0-4
                const newModel = loadedModels[newModelIndex]; // Puede ser un modelo o 'null' si falló la carga

                // Si el modelo que queremos mostrar no es el que ya se está mostrando...
                if (newModel !== currentModel) {
                    
                    // Ocultar el modelo viejo
                    if (currentModel) {
                        currentModel.visible = false;
                    }

                    // Mostrar el modelo nuevo (SOLO SI EXISTE y no es null)
                    if (newModel) {
                        newModel.visible = true;
                    }

                    // Actualizar la referencia al modelo actual
                    currentModel = newModel; 
                }
                
                // Si el modelo actual es nulo (porque falló la carga), no seguir
                if (!currentModel) {
                    // Ocultar gráfico si no hay modelo
                    if (consequencesChart) consequencesChart.data.datasets[0].data = [0,0,0,0,0]; consequencesChart.update();
                    return;
                }

                // --- 2. LÓGICA DE OTROS SLIDERS (aplicada al currentModel) ---
                
                // Param 2 (Negocios) -> Rotación
                const rotationOptions = [0, 45, 90, 135, 180]; 
                const finalRotation = THREE.MathUtils.degToRad(rotationOptions[val2 - 1]);
                currentModel.rotation.y = finalRotation;

                // Param 3 (Perfil) -> Posición Y
                const positionOptions = [-2, -1, 0, 1, 2];
                const sliderPositionY = positionOptions[val3 - 1]; 
                
                // Todos los modelos fueron pre-centrados en X y Z
                currentModel.position.x = 0;
                currentModel.position.z = 0;
                currentModel.position.y = sliderPositionY;
                
                controls.target.set(0, sliderPositionY, 0);

                // Param 4 (Oficios) -> Objeto "Techo"
                const roofObject = currentModel.getObjectByName("Techo"); 
                if (roofObject) {
                    const roofScaleOptions = [0.5, 0.75, 1.0, 1.25, 1.5]; 
                    roofObject.scale.y = roofScaleOptions[val4 - 1];
                } 

                // --- 3. LÓGICA DE ACTUALIZACIÓN DEL GRÁFICO ---
                if (consequencesChart) {
                    const costo = val1 * 2 + val3; 
                    const ruido = val1 + val2;    
                    const confort = 10 - val1;    
                    const ocio = val2 + val3;     
                    const trabajo = val4 * 2;   
                    
                    consequencesChart.data.datasets[0].data = [costo, ruido, confort, ocio, trabajo];
                    consequencesChart.update(); 
                }
            } 

            // --- Función para actualizar la caja de información ---
            function updateInfoBox(paramId, value) {
                const info = parameterInfo[paramId];
                // El valor del slider es de 1 a 5, pero los arrays empiezan en 0.
                const description = info.descriptions[value - 1]; 

                if (infoBox && info && description) {
                    infoBox.innerHTML = `<h3>${info.title}</h3><p>${description}</p>`;
                }
            }

            // --- LÓGICA DE CARGA DE MÚLTIPLES MODELOS ---
            const loadingManager = new THREE.LoadingManager();
            const loader = new GLTFLoader(loadingManager);

            modelFiles.forEach((file, index) => {
                loader.load(file, 
                    (gltf) => { // onLoad
                        const model = gltf.scene;
                        
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        
                        model.position.sub(center); 
                        const scale = 6 / maxDim; 
                        model.scale.set(scale, scale, scale);

                        model.visible = false; 
                        scene.add(model);
                        loadedModels[index] = model; 
                        
                        console.log(`Modelo ${file} cargado y guardado en el índice ${index}`);
                    }, 
                    undefined, 
                    (error) => { // onError
                        console.error(`Error cargando el modelo ${file}:`, error);
                        loadedModels[index] = null; // Guardar null si falla
                    }
                );
            });

            // Cuando TODOS los modelos terminen de cargar
            loadingManager.onLoad = function () {
                console.log("¡Todos los modelos fueron cargados!");
                loadingIndicator.style.display = 'none'; 

                // Crear el gráfico
                initializeChart();
                
                // Correr la lógica de actualización UNA VEZ para mostrar el modelo inicial
                updateModelParameters(); 
                // Mostrar la información inicial
                updateInfoBox('param1', controlsObj.param1.value);
                
                // Forzar el 'target' de la cámara a la posición inicial del modelo
                const initialSliderValueY = [ -2, -1, 0, 1, 2 ][parseInt(controlsObj.param3.value) - 1];
                controls.target.set(0, initialSliderValueY, 0);
                controls.update(); 
                
                // Empezar a animar
                animate(); 
            };

            // Mostrar el progreso de carga total
            loadingManager.onProgress = function ( url, itemsLoaded, itemsTotal ) {
                const percentComplete = (itemsLoaded / itemsTotal * 100).toFixed(0);
                loadingIndicator.textContent = `Cargando ${itemsLoaded} de ${itemsTotal} modelos... ${percentComplete}%`;
            };

            loadingManager.onError = function ( url ) {
                console.error('Hubo un error cargando un modelo: ' + url);
                loadingIndicator.textContent = 'Error al cargar un modelo. Revisa la consola (F12).';
            };


            // --- Función para inicializar el gráfico ---
            function initializeChart() {
                const ctx = document.getElementById('radarChart').getContext('2d');
                if (!ctx) {
                    console.error("No se pudo encontrar el canvas del gráfico.");
                    return;
                }
                consequencesChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Costo', 'Ruido', 'Confort', 'Ocio', 'Trabajo'], // Ejes
                        datasets: [{
                            label: 'Consecuencias',
                            data: [5, 5, 5, 5, 5], // Datos iniciales
                            fill: true,
                            backgroundColor: 'rgba(255, 20, 147, 0.4)',
                            borderColor: 'rgb(255, 20, 147)',
                            pointBackgroundColor: 'rgb(255, 20, 147)',
                            pointBorderColor: '#fff',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Se ajusta al contenedor
                        scales: {
                            r: { 
                                beginAtZero: true,
                                max: 15, // Ajusta esto según tus cálculos
                                angleLines: { color: '#ccc' }, 
                                grid: { color: '#ddd' }, 
                                pointLabels: { 
                                    font: { 
                                        family: "'Thermal VF', monospace",
                                        size: 14 
                                    },
                                    color: '#000'
                                },
                                ticks: {
                                    display: false,
                                    backdropColor: 'rgba(255, 255, 255, 0.7)',
                                    color: '#333'
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // --- Event Listeners para Sliders ---
            Object.values(controlsObj).forEach(control => {
                control.addEventListener('input', (event) => {
                    updateModelParameters(); 
                    // Cada vez que un slider cambia, actualizamos la caja de info
                    updateInfoBox(event.target.id, event.target.value);
                }); 
            });

            // --- Animation Loop ---
            function animate() {
                requestAnimationFrame(animate);
                controls.update(); 
                renderer.render(scene, camera);
            }

            // --- Responsiveness ---
            window.addEventListener('resize', () => {
                const container = document.querySelector('.visualization-column');
                if (container) {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
                }
                if (consequencesChart) {
                    consequencesChart.resize();
                }
            });
            
            window.dispatchEvent(new Event('resize'));

        } catch (error) {
            console.error("Error initializing:", error);
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.textContent = 'Error en la inicialización.';
        }

        // --- "ESPÍA" DE POSICIÓN DE CÁMARA (Tecla 'P') ---
        window.addEventListener('keydown', (event) => {
            if (event.key === 'p' || event.key === 'P') {
                const camera = scene.getObjectByProperty('isPerspectiveCamera', true);
                if (camera) {
                    console.log('Posición de la cámara:', camera.position);
                }
            }
        });

    </script>

</body>
</html>